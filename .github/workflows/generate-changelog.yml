name: Release Pipeline

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., v1.0.0)'
        required: true
        type: string
      create_pr:
        description: 'Create PR instead of direct commit'
        required: false
        type: boolean
        default: false

jobs:
  # Diğer işleriniz (build, test, vs.)
  build:
    runs-on: self-hosted
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Build application
      run: |
        echo "Building application..."
        # Buraya build komutlarınız

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Run tests
      run: |
        echo "Running tests..."
        # Buraya test komutlarınız

  # Changelog güncelleme işi
  update-changelog:
    needs: [build, test]  # Önce build ve test tamamlanmalı
    uses: ./.github/workflows/changelog.yml  # Yukarıdaki workflow dosyasının yolu
    with:
      version: ${{ github.event.release.tag_name || github.event.inputs.version || github.ref_name }}
      create_pr: ${{ github.event.inputs.create_pr || false }}
      changelog_path: 'CHANGELOG.md'  # İsteğe bağlı, varsayılan değer
      # commit_range: 'v1.0.0..HEAD'  # İsteğe bağlı özel commit aralığı
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Changelog güncellemesinden sonra çalışacak işler
  deploy:
    needs: update-changelog
    if: needs.update-changelog.outputs.changelog_updated == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Deploy
      run: |
        echo "Deploying application..."
        echo "Changelog updated: ${{ needs.update-changelog.outputs.changelog_updated }}"
        # Buraya deploy komutlarınız

  notify:
    needs: [update-changelog, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Notify team
      run: |
        echo "Pipeline completed!"
        if [ "${{ needs.update-changelog.outputs.pr_number }}" != "" ]; then
          echo "PR created: #${{ needs.update-changelog.outputs.pr_number }}"
        fi
