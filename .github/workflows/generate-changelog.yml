on:
  workflow_call:
    inputs:
      base_sha:
        required: true
        type: string
      head_sha:
        required: true
        type: string

jobs:
  changelog-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate formatted CHANGELOG
        run: |
          REPO_URL="https://github.com/${{ github.repository }}"
          VERSION=$(cat VERSION 2>/dev/null || echo "v1.0.0")
          DATE=$(date +"%Y-%m-%d")

          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
          fi

          echo -e "\n## $DATE - $VERSION\n" >> CHANGELOG.md

          COMMITS=$(git log ${{ inputs.base_sha }}..${{ inputs.head_sha }} --pretty=format:"%H|%s")

          FEATURES=""
          FIXES=""
          CHORES=""

          while IFS='|' read -r HASH MESSAGE; do
            CLEANED_MSG=$(echo "$MESSAGE" | sed -E 's/^(feat|fix|chore):\s*//')
            LINK="- [$CLEANED_MSG]($REPO_URL/commit/$HASH)"
            if [[ "$MESSAGE" == feat:* ]]; then
              FEATURES+="$LINK\n"
            elif [[ "$MESSAGE" == fix:* ]]; then
              FIXES+="$LINK\n"
            elif [[ "$MESSAGE" == chore:* ]]; then
              CHORES+="$LINK\n"
            fi
          done <<< "$COMMITS"

          [[ -n "$FEATURES" ]] && echo -e "### Features\n$FEATURES" >> CHANGELOG.md
          [[ -n "$FIXES" ]] && echo -e "### Fixes\n$FIXES" >> CHANGELOG.md
          [[ -n "$CHORES" ]] && echo -e "### Chore\n$CHORES" >> CHANGELOG.md

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md
