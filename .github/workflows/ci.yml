name: Build WfmUser App
on:
  push:
    branches:
      - main
  pull_request:
jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Selecting Xcode Version
        run: sudo xcode-select -switch /Applications/Xcode_16.3.app
          
      - name: Copy HERE SDK from local machine
        run: |
          cd $GITHUB_WORKSPACE
          mkdir -p heresdk/frameworks
          cp -R /Users/birol/Desktop/heresdk/frameworks/heresdk.xcframework heresdk/frameworks/
     
      - name: Check if heresdk.xcframework exists
        run: ls -l heresdk/frameworks/heresdk.xcframework
        
      - name: Running Xcode version Is?
        run: /usr/bin/xcodebuild -version

      - name: Build Cleanup
        run: |
          xcodebuild clean -project WfmUser.xcodeproj -scheme WfmUser | xcpretty

            
      - name: Build Test
        run: |
          xcodebuild test -project WfmUser.xcodeproj -scheme WfmUser -destination 'platform=iOS   Simulator,name=iPhone 16,OS=18.2' | xcpretty -s

      - name: Build Archive
        uses: yukiarrr/ios-build-action@v1.5.0  
        with:
          project-path: GitHubAction.xcodeproj
          scheme: WfmUser
          configuration: Release
          export-method: app-store
          p12-base64: ${{ secrets.P12_KEY_BASE64 }}
          mobileprovision-base64: ${{ secrets.MOBILEPROVISION_BASE64 }}
          code-signing-identity: ${{ secrets.CODE_SIGNING_IDENTITY }}
          team-id: ${{ secrets.TEAM_ID }}

      - name: Saving IPA File
        uses: actions/upload-artifact@v4 
        with:
          name: ipa
          path: ./**.ipa

      - name: Upload App
        if: success()
        env:
          APPLEID_USERNAME: ${{ secrets.APPLEID_USERNAME }}
          APPLEID_PASSWORD: ${{ secrets.APPLEID_PASSWORD }}
        run: |
          xcrun altool --upload-app -t ios -f ./**.ipa -u "$APPLEID_USERNAME" -p "$APPLEID_PASSWORD" --verbose
