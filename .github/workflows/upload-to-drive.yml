name: Upload Docs to Drive
on:
  workflow_call:
    inputs:
      folder_name:
        required: true
        type: string

jobs:
  upload:
    runs-on: self-hosted
    steps:
     # - name: Setup rclone config
     #   run: |
     #     mkdir -p ~/.config/rclone
     #     echo "${{ secrets.RCLONE_CONF }}" > ~/.config/rclone/rclone.conf

     # - name: Setup rclone config
     #   run: |
     #     mkdir -p ~/.config/rclone
     #     # İçeriği dosyaya yaz
     #     cat > ~/.config/rclone/rclone.conf << EOF
     #     ${{ secrets.RCLONE_CONF }}
     #     EOF

     #     # DOSYANIN İÇERİĞİNİ YAZDIR (DEBUG AMAÇLI - HATA AYIKLAMA SONRASI KALDIR!)
     #     echo "--- rclone.conf İçeriği (DEBUG ONLY!) ---"
     #     cat ~/.config/rclone/rclone.conf
     #     echo "--- rclone.conf İçeriği Sonu ---"   

      - name: Read version and build from Xcode settings
        run: |
          VERSION=$(xcodebuild -project WfmUser.xcodeproj -scheme WfmUser -showBuildSettings | grep MARKETING_VERSION | awk '{print $3}')
          BUILD=$(xcodebuild -project WfmUser.xcodeproj -scheme WfmUser -showBuildSettings | grep CURRENT_PROJECT_VERSION | awk '{print $3}')
          FOLDER_NAME="v${VERSION}_${BUILD}"
          echo "📁 Version: $VERSION"
          echo "📦 Build: $BUILD"
          echo "📂 Folder Name: $FOLDER_NAME"
          echo "FOLDER_NAME=$FOLDER_NAME" >> "$GITHUB_ENV"

      - name: Print FOLDER_NAME for debug
        run: |
          echo "✅ Generated folder name: $FOLDER_NAME"

      - name: Read folder name
        run: echo "Uploading to folder: ${{ inputs.folder_name }}"

      - name: Upload docs to Google Drive
        run: |
          rclone copy docs gdrive:/MOBILDOKUMANLAR/WfmUser-iOS/${{ env.FOLDER_NAME }}/Docs --create-empty-src-dirs --drive-chunk-size=64M --progress

      - name: Upload SnapshotTests to Google Drive
        run: |
          rclone copy "/Users/birol/actions-runner/_work/WfmUser-iOS/WfmUser-iOS/WfmUserTests/__Snapshots__/SnapshotTests" \
          gdrive:/MOBILDOKUMANLAR/WfmUser-iOS/${{ env.FOLDER_NAME }}/Snapshot \
          --create-empty-src-dirs \
          --drive-chunk-size=64M \
          --progress

      - name: Create Git Tag
        env:
          TAG_NAME: "release${{ env.FOLDER_NAME }}"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
    
          git tag "$TAG_NAME"
    
          # GITHUB_TOKEN ile push işlemi için authentication ayarı
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
    
          git push origin "$TAG_NAME"
